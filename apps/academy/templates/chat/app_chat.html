{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}Chat - Apps{% endblock %}

{% block vendor_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/bootstrap-maxlength/bootstrap-maxlength.css' %}" />
{% endblock vendor_css %}

{% block vendor_js %}
{{ block.super }}
<script src="{% static 'vendor/libs/bootstrap-maxlength/bootstrap-maxlength.js' %}"></script>
{% endblock vendor_js %}

{% block page_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/css/pages/app-chat.css' %}" />
<style>
  .chat-history-body {
    height: calc(100vh - 22rem);
    overflow-y: auto;
  }
</style>
{% endblock page_css %}

{% block page_js %}
{{ block.super }}
<script src="{% static 'js/app-chat.js' %}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var chatHistoryBody = document.querySelector(".chat-history-body");
        if (chatHistoryBody) {
            chatHistoryBody.scrollTop = chatHistoryBody.scrollHeight;
        }
    });
</script>
{% endblock page_js %}

{% block content %}
<div class="app-chat card overflow-hidden">
  <div class="row g-0">
    
    <div class="col app-chat-sidebar-left app-sidebar overflow-hidden" id="app-chat-sidebar-left">
      <div class="chat-sidebar-left-user sidebar-header d-flex flex-column justify-content-center align-items-center flex-wrap px-5 pt-12">
        <div class="avatar avatar-xl avatar-online chat-sidebar-avatar">
          <img src="{{ user_avatar|default:'/static/img/avatars/1.png' }}" alt="Avatar" class="rounded-circle">
        </div>
        <h5 class="mt-4 mb-0">{{ user.first_name }} {{ user.last_name }}</h5>
        <span>{{ user.username }}</span> 
        <i class="ri-close-line ri-24px cursor-pointer close-sidebar" data-bs-toggle="sidebar" data-overlay data-target="#app-chat-sidebar-left"></i>
      </div>
      <div class="sidebar-body px-5 pb-5">
          <div class="my-6">
          <p class="text-uppercase mb-1 text-muted">Informasi Akun</p>
          <ul class="list-unstyled d-grid gap-3 mb-0 ms-2 py-2 text-heading">
             <li class="d-flex align-items-center">
              <i class='ri-user-line ri-22px'></i>
              <span class="align-middle ms-2">ID: {{ user.id }}</span>
            </li>
            <li class="d-flex align-items-center">
              <i class='ri-mail-line ri-22px'></i>
              <span class="align-middle ms-2">{{ user.email|default:"-" }}</span>
            </li>
          </ul>
        </div>
        <div class="d-flex mt-6">
          <a href="{% url 'logout' %}" class="btn btn-primary w-100">Logout <i class='ri-logout-box-r-line ri-16px ms-2'></i></a>
        </div>
      </div>
    </div>

    <div class="col app-chat-contacts app-sidebar flex-grow-0 overflow-hidden border-end" id="app-chat-contacts">
      <div class="sidebar-header h-px-75 px-5 border-bottom d-flex align-items-center">
        <div class="d-flex align-items-center me-6 me-lg-0">
          <div class="flex-shrink-0 avatar avatar-online me-4" data-bs-toggle="sidebar" data-overlay="app-overlay-ex" data-target="#app-chat-sidebar-left">
            <img class="user-avatar rounded-circle cursor-pointer" src="{{ user_avatar|default:'/static/img/avatars/1.png' }}" alt="Avatar">
          </div>
          <div class="flex-grow-1 input-group input-group-sm input-group-merge rounded-pill">
            <span class="input-group-text" id="basic-addon-search31"><i class="ri-search-line lh-1 ri-20px"></i></span>
            <input type="text" class="form-control chat-search-input" placeholder="Cari..." aria-label="Search..." aria-describedby="basic-addon-search31">
          </div>
        </div>
        <i class="ri-close-line ri-24px cursor-pointer position-absolute top-50 end-0 translate-middle fs-4 d-lg-none d-block" data-overlay data-bs-toggle="sidebar" data-target="#app-chat-contacts"></i>
      </div>
      
      <div class="sidebar-body">
        
        <ul class="list-unstyled chat-contact-list py-2 mb-0" id="chat-list">
          <li class="chat-contact-list-item chat-contact-list-item-title mt-0">
            <h5 class="text-primary mb-0">Percakapan</h5>
          </li>
          {% for chat in sidebar_chats %}
          <li class="chat-contact-list-item {% if active_room.id == chat.room_id %}active{% endif %} mb-1">
            <a class="d-flex align-items-center" href="{% url 'chat-detail' chat.room_id %}">
              <div class="flex-shrink-0 avatar {% if chat.is_online %}avatar-online{% else %}avatar-offline{% endif %}">
                <img src="{{ chat.avatar|default:'/static/img/avatars/default.png' }}" alt="Avatar" class="rounded-circle">
              </div>
              <div class="chat-contact-info flex-grow-1 ms-4">
                <div class="d-flex justify-content-between align-items-center">
                  <h6 class="chat-contact-name text-truncate m-0 fw-normal">{{ chat.name }}</h6>
                  <small class="text-muted">{{ chat.time|date:"H:i" }}</small>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-1">
                    <small class="chat-contact-status text-truncate">{{ chat.last_message|truncatechars:30 }}</small>
                    {% if chat.unread_count > 0 %}
                        <span class="badge rounded-pill bg-danger badge-center">{{ chat.unread_count }}</span>
                    {% endif %}
                </div>
              </div>
            </a>
          </li>
          {% empty %}
          <li class="chat-contact-list-item">
             <p class="text-muted small ms-3 mt-2">Belum ada percakapan aktif.</p>
          </li>
          {% endfor %}
        </ul> 
        
        <ul class="list-unstyled chat-contact-list py-2 mb-0" id="contact-list">
          <li class="chat-contact-list-item chat-contact-list-item-title mt-3">
            <h5 class="text-primary mb-0">Kontak Baru</h5>
          </li>

          {% for contact in contacts %}
          <li class="chat-contact-list-item mb-1">
            <a class="d-flex align-items-center" href="{% url 'chat-start' contact.id %}">
              <div class="flex-shrink-0 avatar avatar-offline">
                <img src="{{ contact.avatar }}" alt="Avatar" class="rounded-circle">
              </div>
              <div class="chat-contact-info flex-grow-1 ms-4">
                <div class="d-flex justify-content-between align-items-center">
                  <h6 class="chat-contact-name text-truncate m-0 fw-normal">{{ contact.name }}</h6>
                </div>
                <small class="chat-contact-status text-truncate">{{ contact.role }}</small>
              </div>
            </a>
          </li>
          {% empty %}
          <li class="chat-contact-list-item">
            <div class="p-3 text-center">
                <p class="text-muted small mb-0">Tidak ada user lain ditemukan.</p>
            </div>
          </li>
          {% endfor %}
        </ul>

      </div>
    </div>

    <div class="col app-chat-history">
      <div class="chat-history-wrapper">
        
        <div class="chat-history-header border-bottom">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex overflow-hidden align-items-center">
              <i class="ri-menu-line ri-24px cursor-pointer d-lg-none d-block me-4" data-bs-toggle="sidebar" data-overlay data-target="#app-chat-contacts"></i>
              
              {% if active_room %}
                  <div class="flex-shrink-0 avatar {% if active_room.room_type == 'group' %}avatar-offline{% else %}avatar-online{% endif %}">
                    {% if active_room.room_type == 'group' %}
                        <span class="avatar-initial rounded-circle bg-label-primary"><i class="ri-team-line"></i></span>
                    {% else %}
                        <img src="{{ active_partner.avatar|default:'/static/img/avatars/default.png' }}" alt="Avatar" class="rounded-circle" data-bs-toggle="sidebar" data-overlay data-target="#app-chat-sidebar-right">
                    {% endif %}
                  </div>
                  
                  <div class="chat-contact-info flex-grow-1 ms-4">
                    <h6 class="m-0 fw-normal">
                        {% if active_room.room_type == 'group' %}
                            {{ active_room.name }}
                        {% else %}
                            {{ active_partner.name }}
                        {% endif %}
                    </h6>
                    <small class="user-status text-body">
                        {% if active_room.room_type == 'group' %}
                            Group Chat
                        {% else %}
                            {{ active_partner.role }}
                        {% endif %}
                    </small>
                  </div>
              {% else %}
                  <h6 class="m-0 fw-normal">Pilih kontak atau grup untuk memulai chat</h6>
              {% endif %}
            </div>
            
            {% if active_room %}
            <div class="d-flex align-items-center">
              <div class="dropdown">
                <button class="btn btn-sm btn-icon btn-text-secondary rounded-pill dropdown-toggle hide-arrow" data-bs-toggle="dropdown" aria-expanded="true"><i class="ri-more-2-line ri-20px"></i></button>
                <div class="dropdown-menu dropdown-menu-end">
                  <a class="dropdown-item" href="javascript:void(0);" data-bs-toggle="sidebar" data-overlay data-target="#app-chat-sidebar-right">Lihat Detail</a>
                  <a class="dropdown-item" href="javascript:void(0);">Bersihkan Chat</a>
                </div>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
        
        <div class="chat-history-body">
          <ul class="list-unstyled chat-history">
            {% if active_room %}
                {% for msg in messages %}
                <li class="chat-message {% if msg.sender == user %}chat-message-right{% endif %}">
                <div class="d-flex overflow-hidden">
                    
                    {% if msg.sender != user %}
                    <div class="user-avatar flex-shrink-0 me-4">
                        <div class="avatar avatar-sm">
                            {% if msg.sender.usermhs.photo %}
                                <img src="{{ msg.sender.usermhs.photo.url }}" class="rounded-circle" title="{{ msg.sender.first_name }}">
                            {% elif msg.sender.userdosen.photo %}
                                <img src="{{ msg.sender.userdosen.photo.url }}" class="rounded-circle" title="{{ msg.sender.first_name }}">
                            {% else %}
                                <span class="avatar-initial rounded-circle bg-label-secondary" title="{{ msg.sender.username }}">{{ msg.sender.username|slice:":1" }}</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <div class="chat-message-wrapper flex-grow-1">
                        {% if active_room.room_type == 'group' and msg.sender != user %}
                            <small class="text-muted ms-1 mb-1 d-block" style="font-size: 0.75rem;">{{ msg.sender.first_name }}</small>
                        {% endif %}

                        <div class="chat-message-text">
                            <p class="mb-0">{{ msg.content|linebreaksbr }}</p>
                        </div>
                        <div class="{% if msg.sender == user %}text-end{% endif %} text-muted mt-1">
                            {% if msg.sender == user %}
                                {% if msg.is_read %}
                                    <i class='ri-check-double-line ri-14px text-success me-1'></i>
                                {% else %}
                                    <i class='ri-check-line ri-14px me-1'></i>
                                {% endif %}
                            {% endif %}
                            <small>{{ msg.created_at|date:"H:i" }}</small>
                        </div>
                    </div>
                    
                    {% if msg.sender == user %}
                    <div class="user-avatar flex-shrink-0 ms-4">
                        <div class="avatar avatar-sm">
                            <img src="{{ user_avatar|default:'/static/img/avatars/1.png' }}" alt="Avatar" class="rounded-circle">
                        </div>
                    </div>
                    {% endif %}

                </div>
                </li>
                {% empty %}
                <li class="text-center my-5">
                    <div class="avatar avatar-xl bg-label-secondary rounded-circle mb-3 mx-auto">
                        <i class="ri-chat-smile-2-line ri-3x"></i>
                    </div>
                    <p class="text-muted">Belum ada pesan. Sapa sekarang! ðŸ‘‹</p>
                </li>
                {% endfor %}
            {% else %}
                <li class="d-flex justify-content-center align-items-center h-100">
                    <div class="text-center">
                        <div class="avatar avatar-xl bg-label-primary rounded-circle mb-3 mx-auto">
                            <i class="ri-chat-smile-3-line ri-3x"></i>
                        </div>
                        <h5>Selamat Datang di Chat App</h5>
                        <p class="text-muted">Pilih teman atau grup dari sidebar kiri <br>untuk memulai percakapan.</p>
                    </div>
                </li>
            {% endif %}
          </ul>
        </div>

        <div class="chat-history-footer">
          {% if active_room %}
          <form method="POST" action="{% url 'chat-detail' active_room.id %}" class="d-flex justify-content-between align-items-center">
            {% csrf_token %}
            <input name="message" class="form-control message-input me-4 shadow-none" placeholder="Ketik pesan anda..." required autocomplete="off">
            <div class="message-actions d-flex align-items-center">
              <button type="submit" class="btn btn-primary d-flex send-msg-btn">
                <span class="align-middle">Kirim</span>
                <i class="ri-send-plane-line ri-16px ms-md-2 ms-0"></i>
              </button>
            </div>
          </form>
          {% else %}
             <div class="p-3 bg-lighter text-center text-muted small rounded">
                Pilih kontak untuk mengirim pesan
             </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col app-chat-sidebar-right app-sidebar overflow-hidden" id="app-chat-sidebar-right">
      <div class="sidebar-header d-flex flex-column justify-content-center align-items-center flex-wrap px-5 pt-12">
        <div class="avatar avatar-xl avatar-online chat-sidebar-avatar">
            {% if active_room.room_type == 'group' %}
                <span class="avatar-initial rounded-circle bg-label-primary display-4"><i class="ri-team-line"></i></span>
            {% else %}
                <img src="{{ active_partner.avatar|default:'/static/img/avatars/default.png' }}" alt="Avatar" class="rounded-circle">
            {% endif %}
        </div>
        <h5 class="mt-4 mb-0">
            {% if active_room.room_type == 'group' %}
                {{ active_room.name }}
            {% else %}
                {{ active_partner.name }}
            {% endif %}
        </h5>
        <span>
            {% if active_room.room_type == 'group' %}
                Group Chat
            {% else %}
                {{ active_partner.role }}
            {% endif %}
        </span>
        <i class="ri-close-line ri-24px cursor-pointer close-sidebar d-block" data-bs-toggle="sidebar" data-overlay data-target="#app-chat-sidebar-right"></i>
      </div>
      
      <div class="sidebar-body px-6">
        <div class="my-6">
          <p class="text-uppercase mb-1 text-muted">Informasi</p>
          <ul class="list-unstyled d-grid gap-3 mb-0 ms-2 py-2 text-heading">
             
             {% if active_room.room_type == 'group' %}
                <li class="d-flex align-items-center">
                    <i class='ri-hashtag ri-22px'></i>
                    <span class="align-middle ms-2">Tipe: Grup Diskusi</span>
                </li>
                <li class="d-flex align-items-center">
                    <i class='ri-group-line ri-22px'></i>
                    <span class="align-middle ms-2">Anggota: {{ active_room.participants.count }} Orang</span>

                </li>
                <li class="d-flex align-items-center">
                    <i class='ri-calendar-line ri-22px'></i>
                    <span class="align-middle ms-2">Dibuat: {{ active_room.created_at|date:"d M Y" }}</span>
                </li>

                <hr class="my-4">
            
            <p class="text-uppercase mb-3 text-muted">Anggota ({{ active_partner.members|length }})</p>
            <ul class="list-unstyled chat-contact-list mb-0">
                {% for member in active_partner.members %}
                <li class="chat-contact-list-item d-flex align-items-center mb-3">
                    <div class="flex-shrink-0 avatar avatar-sm">
                        <img src="{{ member.avatar }}" alt="Avatar" class="rounded-circle">
                    </div>
                    <div class="chat-contact-info flex-grow-1 ms-3">
                        <h6 class="chat-contact-name text-truncate m-0 fw-normal fs-6">{{ member.name }}</h6>
                        <small class="text-muted">{{ member.role }}</small>
                    </div>
                </li>
                {% endfor %}
            </ul>

             {% else %}
                <li class="d-flex align-items-center">
                    <i class='ri-user-line ri-22px'></i>
                    <span class="align-middle ms-2">User ID: {{ active_partner.id|default:"-" }}</span>
                </li>
                <li class="d-flex align-items-center">
                    <i class='ri-time-line ri-22px'></i>
                    <span class="align-middle ms-2">Status: {% if active_partner.is_online %}Online{% else %}Offline{% endif %}</span>
                </li>
                <li class="d-flex align-items-center">
                    <i class='ri-mail-line ri-22px'></i>
                    <span class="align-middle ms-2">{{ active_partner.email|default:"-" }}</span>
                </li>
                <li class="d-flex align-items-center">
                    <i class='ri-phone-line ri-22px'></i>
                    <span class="align-middle ms-2">{{ active_partner.phone|default:"-" }}</span>
                </li>
             {% endif %}

          </ul>
        </div>
        
        <div class="d-flex mt-6">
            {% if active_room.room_type == 'group' %}
                <button class="btn btn-label-danger w-100" onclick="alert('Fitur keluar grup belum tersedia.')">
                    Keluar Grup<i class='ri-logout-circle-r-line ri-16px ms-2'></i>
                </button>
            {% else %}
                <button class="btn btn-danger w-100" onclick="alert('Fitur blokir belum tersedia.')">
                    Block Contact<i class='ri-forbid-line ri-16px ms-2'></i>
                </button>
            {% endif %}
        </div>
      </div>
    </div>
    
    <div class="app-overlay"></div>
  </div>
</div>
{% endblock %}